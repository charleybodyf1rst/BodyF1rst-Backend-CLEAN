# Validate origin against whitelist
set $validated_origin "";
if ($http_origin ~* "^https://bodyf1rst\.net$") { set $validated_origin $http_origin; }
if ($http_origin ~* "^https://www\.bodyf1rst\.net$") { set $validated_origin $http_origin; }
if ($http_origin ~* "^https://app\.bodyf1rst\.net$") { set $validated_origin $http_origin; }
if ($http_origin ~* "^https://admin-bodyf1rst\.com$") { set $validated_origin $http_origin; }
if ($http_origin ~* "^https://www\.admin-bodyf1rst\.com$") { set $validated_origin $http_origin; }
# Amplify branch URLs are typically: <branch>.<appId>.amplifyapp.com (two labels)
if ($http_origin ~* "^https://[a-z0-9-]+\.[a-z0-9-]+\.amplifyapp\.com$") { set $validated_origin $http_origin; }
if ($http_origin ~* "^http://localhost:4200$") { set $validated_origin $http_origin; }
if ($http_origin ~* "^http://localhost:8100$") { set $validated_origin $http_origin; }

# Compute credentials flag once
set $allow_creds "";
if ($validated_origin != "") { set $allow_creds "true"; }

# Note: allow app/Laravel CORS headers to pass through.
# We still add validated headers below to guarantee presence on errors.

# Add CORS headers for all responses generated by Nginx (including 4xx/5xx)
add_header Access-Control-Allow-Origin $validated_origin always;
add_header Access-Control-Allow-Credentials $allow_creds always;
add_header Vary "Origin" always;

# Fast preflight path
if ($request_method = OPTIONS) {
    add_header Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Authorization, Content-Type, X-Requested-With, X-CSRF-TOKEN, X-XSRF-TOKEN" always;
    return 204;
}
